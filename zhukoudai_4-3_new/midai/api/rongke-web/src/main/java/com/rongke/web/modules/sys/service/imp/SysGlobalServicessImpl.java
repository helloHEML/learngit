package com.rongke.web.modules.sys.service.imp;import com.baomidou.mybatisplus.mapper.EntityWrapper;import com.baomidou.mybatisplus.service.impl.ServiceImpl;import com.rongke.enums.GlobalEnums;import com.rongke.mapper.SysGlobalMapper;import com.rongke.model.Admin;import com.rongke.model.AdminRole;import com.rongke.model.SysGlobal;import com.rongke.model.SysOnline;import com.rongke.rediscluster.CacheUtil;import com.rongke.service.AdminRoleService;import com.rongke.service.AdminService;import com.rongke.utils.RRUtils;import com.rongke.utils.RandomUtils;import com.rongke.utils.ans.R;import com.rongke.web.modules.sys.service.LogSmsService;import com.rongke.web.modules.sys.service.SysGlobalssService;import com.rongke.web.modules.sys.service.SysOnlineService;import com.rongke.web.saas.RSSmsUtils;import com.rongke.web.sms.SmsUtils;import org.apache.commons.codec.digest.DigestUtils;import org.apache.commons.lang3.StringUtils;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Service;import java.util.Map;/** *  app 功能管理 */@Servicepublic class SysGlobalServicessImpl extends ServiceImpl<SysGlobalMapper,SysGlobal> implements SysGlobalssService {    @Autowired    private CacheUtil cache;    @Autowired    private SmsUtils smsUtil;    @Autowired    private AdminService adminService;    @Autowired    private AdminRoleService adminRoleService;    @Autowired    private SysOnlineService sysOnlineService;    @Autowired    private LogSmsService logSmsService;    /**     * 修改打款密码，验证码     */    public R payPassWordCode() throws Exception {        SysOnline online = sysOnlineService.onlineG();        if(online==null){            return R.error("请登录");        }        Admin admin = adminService.findLoginUser();        String code = RandomUtils.randomString(6);        R r = RSSmsUtils.sendsms2(admin.getPhone(), code);        if(RRUtils.assertCode(r,"500")){            return r;        }        return logSmsService.ADDpayUPSms(code);    }    /**     * 修改打款密码     */    public R payPassWord(Map<String, String> params) {        Admin admin = adminService.findLoginUser();        AdminRole role = adminRoleService.selectById(admin);        if(admin.getId()!=1L&&role.getType()!=0){            return R.error("权限不足");        }        if(StringUtils.isBlank(params.get("code"))){            return R.error("请输入验证码");        }        if(StringUtils.isBlank(params.get("newPayPassword"))){            return R.error("打款密码不能为空");        }        SysGlobal key = this.key(GlobalEnums.PAYPASSWORD.getValue());        if(!key.getSysValues().equals(DigestUtils.md5Hex(params.get("jPayPassword")))){            return R.error("原密码验证不正确");        }        R r = logSmsService.ISpayUPSms(params.get("code"));        if(RRUtils.assertCode(r,"500")){            return r;        }        if(key==null){            key = new SysGlobal();            key.setSysName("打款密码");            key.setSysKeys(GlobalEnums.PAYPASSWORD.getKey());            key.setSysType(0);        }        key.setSysValues(DigestUtils.md5Hex(params.get("newPayPassword")));        this.insertOrUpdate(key);        return R.ok();    }    public SysGlobal key(String key){        return this.selectOne(new EntityWrapper<SysGlobal>().eq("sys_keys",key));    }}