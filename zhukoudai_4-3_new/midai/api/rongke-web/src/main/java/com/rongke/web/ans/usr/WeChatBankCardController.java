package com.rongke.web.ans.usr;import com.alibaba.fastjson.JSON;import com.alibaba.fastjson.JSONObject;import com.baomidou.mybatisplus.mapper.EntityWrapper;import com.baomidou.mybatisplus.mapper.Wrapper;import com.google.common.collect.Maps;import com.rongke.enums.StatusEnum;import com.rongke.model.BankCard;import com.rongke.model.ans.TblAccountEntity;import com.rongke.model.ans.WxBandcardEntity;import com.rongke.service.BankCardService;import com.rongke.service.ans.sys.TblAccountService;import com.rongke.service.ans.sys.WxBandcardService;import com.rongke.service.ans.usr.WeChatUserService;import com.rongke.utils.ans.R;import com.rongke.web.ans.utils.YiBaoUtils;import com.rongke.yibaoApi.BindCardApi;import com.rongke.yibaoModel.AuthBindCardBean;import org.apache.commons.lang3.StringUtils;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RequestParam;import org.springframework.web.bind.annotation.RestController;import java.util.Map;/** * 微信用户银行卡 * Create Ans on 2018/8/17 16:14 */@RestController@RequestMapping("api/WeChatBank")public class WeChatBankCardController {    @Autowired    private WxBandcardService wxBandcardService;//银行卡操作    @Autowired    private WeChatUserService weChatUserService;//用户操作    @Autowired    private TblAccountService tblAccountService;//微信用户信息操作    /**     * 绑定银行卡 发送鉴权请求     * @param bankCard     * @return     */    @RequestMapping("/wechatBankCartAuth")    public R bankCardAuto(WxBandcardEntity bankCard){        //获得登陆        TblAccountEntity acount = weChatUserService.selectWechatUser();        //进行绑卡        AuthBindCardBean authBindCardBean = new AuthBindCardBean();        authBindCardBean.setBankCardNo(bankCard.getBankCard()); //银行卡号        authBindCardBean.setPhone(bankCard.getPhone()); //手机号        authBindCardBean.setUserPhone(bankCard.getPhone()); //用户手机号        authBindCardBean.setIdCardNo(bankCard.getIdentityCard()); //身份证号        authBindCardBean.setIssMs("true"); //是否发送短信验证        authBindCardBean.setUserName(bankCard.getName()); //用户姓名        Map<String,Object> bankCartResult = BindCardApi.authBindCardRequest(authBindCardBean);        String banckStatus = (String) bankCartResult.get("status");//易宝绑卡返回状态        if(!banckStatus.equals("TO_VALIDATE")&&!banckStatus.equals("BIND_SUCCESS")){            String errMsg = banckStatus.equals("BIND_FAIL")?"绑卡失败,请确认信息是否正确":banckStatus.equals("BIND_ERROR")?" 绑卡异常(可重试)"                    :banckStatus.equals("TIME_OUT")?"超时失败":banckStatus.equals("FAIL")?"网络异常请重试":"绑卡失败,请确认信息是否正确";            return R.error(errMsg);        }        return R.ok().put("requestno",bankCartResult.get("requestno"));    }    /**     * 鉴权绑卡短信确认     */    @RequestMapping("/wechatBankCardConfirm")    public R bankCardConfirm(WxBandcardEntity bankCard, @RequestParam("code") String code,@RequestParam("requestno") String requestno){        //获得登陆        TblAccountEntity acount = weChatUserService.selectWechatUser();        R resulet = YiBaoUtils.bankCardConfirm(code, requestno, bankCard.getBankCard());        //添加银行卡        if((Integer) resulet.get("code")!=0){            return R.error("绑卡失败");        }        String bankName = (String) resulet.get("bankName");        bankCard.setAccountId(acount.getAccountId());//设置用户        bankCard.setBankCard((String) resulet.get("bankCode"));//银行卡号        //设置银行卡名称        R bank = YiBaoUtils.bankCardFind(bankCard.getPhone(), "PHONE");        if(0 == (Integer)bank.get("code")){            JSONObject json = JSON.parseObject((String) bank.get("data"));            bankName = bankName +"-"+json.getString("cardname")+"-"+(String) resulet.get("bankName1");        }        bankCard.setBankName(bankName);//银行卡名称        bankCard.setStatus("使用");        boolean insert = wxBandcardService.insert(bankCard);        //设置用户信息        acount.setAccountName(bankCard.getName());//姓名        acount.setAccountMobile(bankCard.getPhone());//设置手机号        boolean b = tblAccountService.updateById(acount);        return R.ok("绑卡成功").put("data",bankCard);    }    /**     * 微信用户获得个人银行卡     * @return     */    @RequestMapping("/wechatBankCart")    public R getUsrBankCard(@RequestParam String isresult){        //用户信息        TblAccountEntity tblAccountEntity = weChatUserService.selectWechatUser();        //查询银行卡        WxBandcardEntity bankCard = wxBandcardService.selectOne(new EntityWrapper<WxBandcardEntity>()                .eq("Account_ID", tblAccountEntity.getAccountId()).eq("status", StatusEnum.USED.getTypeName()));        if(bankCard==null){            return R.error("银行卡不存在");        }        bankCard.setBankCard("**** **** **** "+bankCard.getBankCard().substring(bankCard.getBankCard().length()-4));        if(StringUtils.isNotBlank(isresult)){            return R.ok().put("data",bankCard);        } else {            return R.ok();        }    }    public static void main(String[] args) {//        AuthBindCardBean authBindCardBean = new AuthBindCardBean();//        authBindCardBean.setPhone("18667159619");//        authBindCardBean.setBankCardNo("6212261202043187781");//        authBindCardBean.setIdCardNo("341225199311184336");//        authBindCardBean.setIssMs("false");//        authBindCardBean.setUserPhone("userPhone");//        authBindCardBean.setUserName("李军");//        Map<String, Object> map = BindCardApi.authBindCardRequest(authBindCardBean);//        long l = System.currentTimeMillis();//        R r = YiBaoUtils.bankCardRecord("6212261202043187781");//        System.err.println(r);//        System.out.println(System.currentTimeMillis()-l);        R r = YiBaoUtils.bankCardFind("52","USER_ID");        System.err.println(r);    }}