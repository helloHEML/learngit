package com.rongke.web;import com.rongke.commons.JsonResp;import com.rongke.model.Coupon;import com.rongke.model.User;import com.rongke.model.UserCoupon;import com.rongke.service.UserCouponService;import com.rongke.service.UserService;import org.apache.log4j.Logger;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.transaction.annotation.Transactional;import org.springframework.web.bind.annotation.*;import java.text.ParseException;import java.util.*;/** * @UserCouponController * @用户优惠券列Controller * @version : Ver 1.0 */@RestController@RequestMapping(value="/api/userCoupon")@Transactional@CrossOriginpublic class UserCouponController {    private Logger log = Logger.getLogger(this.getClass());    @Autowired    private UserCouponService userCouponService;    @Autowired    private UserService userService;    /**     * @添加用户优惠券列     * @param userCoupon     * @return 返回值JsonResp     */    @RequestMapping(value="/add", method = RequestMethod.POST)    public JsonResp addUserCoupon(@RequestBody UserCoupon userCoupon){        log.debug("添加用户优惠券列");        userCoupon.setGmtDatetime(new Date());        userCouponService.insert(userCoupon);        return JsonResp.ok(userCoupon);    }    /**     * @修改用户优惠券列     * @param userCoupon     * @return 返回值JsonResp     */    @RequestMapping(value="/update", method = RequestMethod.POST)    public JsonResp updateUserCoupon(@RequestBody UserCoupon userCoupon){        log.debug("修改用户优惠券列");        userCoupon.setUptDatetime(new Date());        userCouponService.updateById(userCoupon);        return JsonResp.ok(userCoupon);    }    /**     * @根据id查找用户优惠券列     * @param id     * @return 返回值JsonResp     */    @RequestMapping(value="/selectOne", method = RequestMethod.GET)    public JsonResp selectUserCoupon(Long id){        log.debug("查找用户优惠券列");        UserCoupon userCoupon = userCouponService.selectById(id);        return JsonResp.ok(userCoupon);    }    /**     * @param     * @return 返回值JsonResp     * @根据登录用户查找优惠券     */    @RequestMapping(value = "/selectByUser", method = RequestMethod.GET)    public JsonResp selectByUser() throws ParseException {        log.debug("根据登录用户查找优惠券");        User user = userService.selectCurrentUser();        Map<String,Object> map = new HashMap<>();        map.put("userId",user.getId());        map.put("status",1);//可以使用的优惠券        List<UserCoupon> userCoupons=userCouponService.selectUserCoupons(map);        List<UserCoupon> responseList=new ArrayList<>();        for(int i=0,y=userCoupons.size();i<y;i++){            UserCoupon userCoupon=userCoupons.get(i);            Coupon coupon=userCoupon.getCoupon();          /*  //判断优惠券有没有过期            Long time=userCoupon.getGmtDatetime().getTime()+coupon.getValidTime()*24*60*60*1000;*/            if(userCoupon.getPastDatetime().getTime()-System.currentTimeMillis()>0){                responseList.add(userCoupon);            }        }        return JsonResp.ok(responseList);    }}